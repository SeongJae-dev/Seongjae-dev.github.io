{"componentChunkName":"component---src-templates-page-js","path":"/Webclient","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Spring WebClient QueryParam 한국어 인코딩 처리","date":"15 August 2021","path":"/Webclient","author":"Dev-Jo","excerpt":"WebClient 사용시 QueryParam 한국어 인코딩 변환 방법","tags":["Spring","WebClient","Encoding"],"coverImage":null},"id":"a873743d-d425-5885-918a-5bda55b3b54b","html":"<p>Spring WebClient로 Get으로 API를 요청시 QueryParam으로 데이터를 넘겨주게 되는데\n이때 WebClient는 전달되는 QueryParam의 데이터를 인코딩하게 되는데 API 명세와 다르게 데이터가 넘어가 이슈가 발생한다.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e74ee9b9537f7ede55ade4b285ebff5c/8dd80/img.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.999999999999996%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA2klEQVQY0z3Qy07DMBCF4TwMqCVx7MR2fInjNFQqIAo73v9VfiYpYnGk2cx3RtMoneh1ZhgLflpx8ZUxXjA2ybzi0wUbVkzYsGnGxJnOZ5RPmCmifUCNgbPyR5rWJF5MpBWwk5h4xa5fmPLJIMgwVVzdmLYr41x5Xr55uv6g6l1KKjpu9H6lG2Zak2nOavrXT62ltZV+/qDP72i3oIaIrwVXZka5LJdKFFjnN/pyR6cbyq20OnDaLzygzj3ATsBxQe9gkoU/0ApmpkQImSpziOVRKDHypn3vMCS/hH2BKazJuEUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"images\"\n        title=\"images\"\n        src=\"/static/e74ee9b9537f7ede55ade4b285ebff5c/78d47/img.png\"\n        srcset=\"/static/e74ee9b9537f7ede55ade4b285ebff5c/56d15/img.png 200w,\n/static/e74ee9b9537f7ede55ade4b285ebff5c/d9f49/img.png 400w,\n/static/e74ee9b9537f7ede55ade4b285ebff5c/78d47/img.png 800w,\n/static/e74ee9b9537f7ede55ade4b285ebff5c/8dd80/img.png 889w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span> </p>\n<p>GET으로 API를 위처럼 QueryParam으로 전달하는 모든 Value 값이\n임의로 인코딩되어 요청을 받은 서버에서는 Error나 잘 못된 정보라고 아래 처럼 응답이 올 것이다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 766px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/eb14c66e7a1f111d9c62edc542826093/e4da8/img_error_ex.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAzElEQVQY042Q0W6EIBBF/RIFBEVQxsF1bU360DT9/0+6HdjdxPSlfTiBSZiZw22GZYeLGTasAsN4whAXtG0L1XWCnEr9C601mt55jOsJf3wj3T/AOSOlBOYVboxwgWCMgZYGY3S911qaf1OGNsWgPHDzhjHtmPgNeT9wnu+gfANtB4g38LbXZUQkyxghRPR+gZ1IfsjorXsMLJdiON2/4G+fsDK4WIUYYb0wpVq7uKJ3g5ioi6G58DR0c652rxzrtnF+5FLyu6K6PzP8AZdckOyfn1F7AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"images\"\n        title=\"images\"\n        src=\"/static/eb14c66e7a1f111d9c62edc542826093/e4da8/img_error_ex.png\"\n        srcset=\"/static/eb14c66e7a1f111d9c62edc542826093/56d15/img_error_ex.png 200w,\n/static/eb14c66e7a1f111d9c62edc542826093/d9f49/img_error_ex.png 400w,\n/static/eb14c66e7a1f111d9c62edc542826093/e4da8/img_error_ex.png 766w\"\n        sizes=\"(max-width: 766px) 100vw, 766px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>원인은 Api 요청시 식별자 역할을 하는 API key인 serviceKey 값이 WebClient가 임의로 인코딩하여 전달하면서\n달라진 키값으로 요청하기 때문이다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 192px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/df04f6dd87331274d5b258b2b7c02908/3b721/encoding_key_value.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAhklEQVQoz2PQ0DH5D8Pq2sYoNDmYwdTK5X94bPp/v8DI/5oUGgY2UNvA8r+1g+d/OycvqIEmlBmopmX0X0lN77+iqu5/FQ0Dir0NdqGxucN/c2vn/5Z27v+19UwpC0N9U8f/gWHx//2Dov+7egX/19Kl0EAtPfP/Rmb2//WMrP5r6ZlR7GUARZvZe/86QpQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"images\"\n        title=\"images\"\n        src=\"/static/df04f6dd87331274d5b258b2b7c02908/3b721/encoding_key_value.png\"\n        srcset=\"/static/df04f6dd87331274d5b258b2b7c02908/3b721/encoding_key_value.png 192w\"\n        sizes=\"(max-width: 192px) 100vw, 192px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>98은 정상적인 서비스키의 length이고 107은 Webclient 요청시 전달된 서비스키의 length이다.\n이렇게 달라져 버린 키로 인해 정상적인 API를 요청할 수 없다.</p>\n<p>이 이슈의 해결법은 간단하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"> <span class=\"token class-name\">DefaultUriBuilderFactory</span> builderFactory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DefaultUriBuilderFactory</span><span class=\"token punctuation\">(</span>API_URL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n builderFactory<span class=\"token punctuation\">.</span><span class=\"token function\">setEncodingMode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DefaultUriBuilderFactory<span class=\"token punctuation\">.</span>EncodingMode</span><span class=\"token punctuation\">.</span>VALUES_ONLY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      \n <span class=\"token class-name\">WebClient</span> client <span class=\"token operator\">=</span> <span class=\"token class-name\">WebClient</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">uriBuilderFactory</span><span class=\"token punctuation\">(</span>builderFactory<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">baseUrl</span><span class=\"token punctuation\">(</span>API_URL<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">clientConnector</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ReactorClientHttpConnector</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpClient</span><span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>tcpClient<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>WebClient 설정값을 변경해주면 된다. EncodingMode의 기본값은  \"EncodingMode.URI<em>COMPONENT\" 인데\n\"EncodingMode.VALUES</em>ONLY\" 로 설정해 주면 QueryParam으로 넘어가는 데이터의 값이 인코딩 되지 않고 전달하려는 값 그대로\n전달할 수 있다.</p>\n<p>영어, 숫자, 특수문자로 QueryParam을 전달하는 경우에는 위의 방법으로 대부분은 해결이 될 것이다.\n하지만 <strong>한글 등 다른 외국어</strong> 를 QueryParam으로 전달할 경우 아직 이슈가 남아있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 623px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7fe2cb82289e5a4d8c06cc6fa1a5405c/6007f/param_korea_issue.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 6.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAR0lEQVQI12PQd/b5r+/s/V/f0eu/vpPXfz0Hj/96jhBa184NLAaSh/Dd/+sBxUDiZia2/60NLf9bGln9twJiS0Or/yYG5v8BURshzAq0VuUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"images\"\n        title=\"images\"\n        src=\"/static/7fe2cb82289e5a4d8c06cc6fa1a5405c/6007f/param_korea_issue.png\"\n        srcset=\"/static/7fe2cb82289e5a4d8c06cc6fa1a5405c/56d15/param_korea_issue.png 200w,\n/static/7fe2cb82289e5a4d8c06cc6fa1a5405c/d9f49/param_korea_issue.png 400w,\n/static/7fe2cb82289e5a4d8c06cc6fa1a5405c/6007f/param_korea_issue.png 623w\"\n        sizes=\"(max-width: 623px) 100vw, 623px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n위 이미지를 보면 key, numOfRows, pageNo 파라미터는 넘겨준 값이 제대로 전달이 되는데 한글 파라미터를 넘겨줘야 하는\ntitle1~2의 경우 한국어가 그대로 넘겨주면서 이슈가 발생한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 546px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4bbfd4cfcaa8682bb2eb99ddcdfaef0d/8c78b/postman_req.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAVklEQVQI101NSQoAIQzzRxWXWhX1/6+KpOAwh5A2CwkpJYwxsNbC3tv5f/fewYyqwsxcfx75nIM5p/+8Q4wRtVYvkFlqrTkT1EQEOWfH81+Wg6WUb/AC+TpCT60+P0AAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"images\"\n        title=\"images\"\n        src=\"/static/4bbfd4cfcaa8682bb2eb99ddcdfaef0d/8c78b/postman_req.png\"\n        srcset=\"/static/4bbfd4cfcaa8682bb2eb99ddcdfaef0d/56d15/postman_req.png 200w,\n/static/4bbfd4cfcaa8682bb2eb99ddcdfaef0d/d9f49/postman_req.png 400w,\n/static/4bbfd4cfcaa8682bb2eb99ddcdfaef0d/8c78b/postman_req.png 546w\"\n        sizes=\"(max-width: 546px) 100vw, 546px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n이 캡처는 포스트맨으로 같은 API를 요청해 본 것인데 한국어를 전달시에는 한국어가 인코딩되어 전달되어야 한다.</p>\n<h4>QueryParam에서 \"title1=입국\"은  \"title=%EC%9E%85%EA%B5%AD&#x26;\" 형식으로 전달이 되어야 Api가 제대로 전달되는 것이다.</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">DefaultUriBuilderFactory<span class=\"token punctuation\">.</span>EncodingMode</span><span class=\"token punctuation\">.</span>URI_COMPONENT</code></pre></div>\n<p>이를 WebClient에서 해결하기 위해서는 EncodingMode를 다시 기본값 인 \"URI_COMPONENT\" 로 변경시 한국어 파라미터는 인코딩되어 제대로 넘어가지만,\nservicekey 변환 문제가 남아있어 webClient에서 해결이 아닌 다른 방법을 찾아야했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> <span class=\"token function\">queryParamEncodingBuilder</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> title<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">UriComponentsBuilder</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromUri</span><span class=\"token punctuation\">(</span>URI<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toUriString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/224a315d999b0319fda95b686904bde4/6f18b/encoding_korea.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 3%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAU0lEQVQI12PQM7b5b+bo9N8CiE3tHP4bWLr8N3QI/G/kGPTfyCkYiEPA2NAh4L+xc+h/E7eI/wb2/v9NgXIabmH/FfwT/yv5JfyX90/6r+0Z+x8AZGYjJ4U9SjIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"images\"\n        title=\"images\"\n        src=\"/static/224a315d999b0319fda95b686904bde4/78d47/encoding_korea.png\"\n        srcset=\"/static/224a315d999b0319fda95b686904bde4/56d15/encoding_korea.png 200w,\n/static/224a315d999b0319fda95b686904bde4/d9f49/encoding_korea.png 400w,\n/static/224a315d999b0319fda95b686904bde4/78d47/encoding_korea.png 800w,\n/static/224a315d999b0319fda95b686904bde4/6f18b/encoding_korea.png 886w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Spring Web에서 제공하는 API인  UriComponentsBuilder를 이용해 해당 QueryParam 부분에 위의 메서드를 적용해\n\"title1=입국\"을 \"title=%EC%9E%85%EA%B5%AD&#x26;\" 인코딩한 값으로 넘겨주는 형태로 구현했다.</p>\n<p>Spring WebClient 예제가 국내에 별로 없어 이 문제 해결에 삽질을 좀 했다. 한국어를 파라미터로 넘겨주는 경우가 생소해서 정보가 없던거 같은데\n공공 API를 사용하다보니 해당 이슈를 찾게 되었다..</p>","excerpt":"Spring WebClient로 Get으로 API를 요청시 QueryParam으로 데이터를 넘겨주게 되는데\n이때 WebClient는 전달되는 QueryParam의 데이터를 인코딩하게 되는데 API…"}},"pageContext":{"type":"posts","next":{"frontmatter":{"path":"/hello","title":"Hello Friend","tags":["rob____ot","hello friend"]},"fileAbsolutePath":"C:/Users/Seongjae/Projects/blog/devlogjo/src/posts/hello.md"},"previous":null}},"staticQueryHashes":["1425477374","3128451518"]}